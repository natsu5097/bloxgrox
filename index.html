<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blox Fruits Fan Wiki</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>Blox Fruits Fan Wiki</h1>
    <button id="darkModeToggle">🌙 Dark Mode</button>
  </header>

  <!-- Navbar -->
  <nav id="navbar">
    <ul>
      <li><a href="#fruits">Fruits</a></li>
      <li><a href="#fighting-styles">Fighting Styles</a></li>
      <li><a href="#swords">Swords</a></li>
      <li><a href="#guns">Guns</a></li>
      <li><a href="#accessories">Accessories</a></li>
      <li><a href="#races">Races</a></li>
      <li><a href="#locations">Locations</a></li>
      <li><a href="#updates">Updates</a></li>
    </ul>
  </nav>

  <!-- Filters -->
  <div id="filters">
    <button class="filter-btn" data-filter="fruits">Fruits</button>
    <button class="filter-btn" data-filter="fighting-styles">Fighting Styles</button>
    <button class="filter-btn" data-filter="swords">Swords</button>
    <button class="filter-btn" data-filter="guns">Guns</button>
    <button class="filter-btn" data-filter="accessories">Accessories</button>
    <button class="filter-btn" data-filter="races">Races</button>
    <button class="filter-btn" data-filter="locations">Locations</button>
    <button class="filter-btn" data-filter="updates">Updates</button>
  </div>

  <!-- Expand/Collapse -->
  <div id="expand-collapse">
    <button id="expandAll">Expand All</button>
    <button id="collapseAll">Collapse All</button>
  </div>

  <!-- Search -->
  <div id="search-container">
    <input type="text" id="search-bar" placeholder="Search items... (Fruits, Swords, Guns, etc.)">
    <button id="clear-search">✖</button>
  </div>

  <!-- Main content -->
  <main>
    <section id="fruits">
      <h2>Fruits</h2>
      <div id="fruits-sections"></div>
    </section>

    <section id="fighting-styles">
      <h2>Fighting Styles</h2>
      <table id="fighting-styles-table">
        <thead>
          <tr>
            <th>Image</th>
            <th>Name</th>
            <th>Price (Money)</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="swords">
      <h2>Swords</h2>
      <div id="swords-sections"></div>
    </section>

    <section id="guns">
      <h2>Guns</h2>
      <div id="guns-sections"></div>
    </section>

    <section id="accessories">
      <h2>Accessories</h2>
      <div id="accessories-sections"></div>
    </section>

    <section id="races">
      <h2>Races</h2>
      <div id="races-sections"></div>
    </section>

    <section id="locations">
      <h2>Locations</h2>
      <div id="locations-sections"></div>
    </section>

    <section id="updates">
      <h2>Updates</h2>
      <table id="updates-table">
        <thead>
          <tr>
            <th>Version</th>
            <th>Date</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer>
    <p>© 2025 Blox Fruits Fan Wiki. Built for fans!</p>
  </footer>

  <button id="scrollTopBtn">⬆</button>
  <div id="loadingSpinner">Loading...</div>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const body = document.body;
  const darkToggle = document.getElementById("darkModeToggle");
  const links = document.querySelectorAll("#navbar a");
  const filterBtns = document.querySelectorAll(".filter-btn");
  const spinner = document.getElementById("loadingSpinner");
  const searchBar = document.getElementById("search-bar");
  const clearBtn = document.getElementById("clear-search");
  const scrollTopBtn = document.getElementById("scrollTopBtn");

  // Show spinner while loading
  spinner.style.display = "block";

  fetch('data.json')
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      return response.json();
    })
    .then(data => {
      spinner.style.display = "none"; // hide spinner once loaded
      console.log("✅ JSON loaded successfully:", data);

      // --- Rendering functions ---
      function renderGroupedTables(groups, containerId, columns) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';

        Object.keys(groups).forEach(rarity => {
          const section = document.createElement('section');
          section.classList.add('collapsible-section');

          const header = document.createElement('h3');
          header.textContent = rarity;
          header.classList.add('collapsible-header');

          const tableWrapper = document.createElement('div');
          tableWrapper.classList.add('collapsible-content');

          const table = document.createElement('table');
          const thead = document.createElement('thead');
          thead.innerHTML = `<tr>${columns.map(c => `<th>${c.header}</th>`).join('')}</tr>`;
          table.appendChild(thead);

          const tbody = document.createElement('tbody');
          groups[rarity].forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = columns.map(c =>
              c.key === 'image_url'
                ? `<td><img src="${item[c.key] || 'images/placeholder.png'}" alt="${item.name || ''}" style="width:40px;height:40px;"></td>`
                : `<td>${item[c.key] !== undefined ? item[c.key] : ''}</td>`
            ).join('');
            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          tableWrapper.appendChild(table);

          section.appendChild(header);
          section.appendChild(tableWrapper);
          container.appendChild(section);

          header.addEventListener('click', () => {
            tableWrapper.classList.toggle('active');
          });
        });
      }

      // Fruits
      renderGroupedTables(groupByRarity(data.fruits), 'fruits-sections', [
        { header: 'Image', key: 'image_url' },
        { header: 'Name', key: 'name' },
        { header: 'Type', key: 'type' },
        { header: 'Price (Money)', key: 'price_money' },
        { header: 'Price (Robux)', key: 'price_robux' },
        { header: 'Description', key: 'description' }
      ]);

      // Swords
      renderGroupedTables(groupByRarity(data.swords), 'swords-sections', [
        { header: 'Image', key: 'image_url' },
        { header: 'Name', key: 'name' },
        { header: 'Rarity', key: 'rarity' },
        { header: 'Price (Money)', key: 'price_money' },
        { header: 'Price (Robux)', key: 'price_robux' },
        { header: 'Description', key: 'description' }
      ]);

      // Fighting styles
      const fightingStylesTableBody = document.querySelector('#fighting-styles-table tbody');
      data.fightingStyles.forEach(style => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><img src="${style.image_url || 'images/placeholder.png'}" alt="${style.name || ''}" style="width:40px;height:40px;"></td>
          <td>${style.name || ''}</td>
          <td>${style.price_money ? style.price_money.toLocaleString() : ''}</td>
          <td>${style.description || ''}</td>
        `;
        fightingStylesTableBody.appendChild(row);
      });

      // Guns
      renderGroupedTables(groupByRarity(data.guns), 'guns-sections', [
        { header: 'Image', key: 'image_url' },
        { header: 'Name', key: 'name' },
        { header: 'Rarity', key: 'rarity' },
        { header: 'Price (Money)', key: 'price_money' },
        { header: 'Description', key: 'description' }
      ]);

      // Accessories
      renderGroupedTables(groupByRarity(data.accessories), 'accessories-sections', [
        { header: 'Image', key: 'image_url' },
        { header: 'Name', key: 'name' },
        { header: 'Rarity', key: 'rarity' },
        { header: 'Price (Money)', key: 'price_money' },
        { header: 'Description', key: 'description' }
      ]);

      // Races
      renderGroupedTables({ "All Races": data.races }, 'races-sections', [
        { header: 'Image', key: 'image_url' },
        { header: 'Name', key: 'name' },
        { header: 'Description', key: 'description' }
      ]);

      // Locations
      renderGroupedTables({ "Game Worlds": data.locations }, 'locations-sections', [
        { header: 'Image', key: 'image_url' },
        { header: 'Name', key: 'name' },
        { header: 'Description', key: 'description' }
      ]);

      // Updates
      const updatesTableBody = document.querySelector('#updates-table tbody');
      data.updates.forEach(update => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${update.version}</td>
          <td>${update.date}</td>
          <td>${update.details}</td>
        `;
        updatesTableBody.appendChild(row);
      });

      // --- Search functionality ---
      searchBar.addEventListener('input', () => {
        const query = searchBar.value.toLowerCase();
        function filterTable(containerId) {
          const container = document.getElementById(containerId);
          if (!container) return;
          const rows = container.querySelectorAll('tbody tr');
          rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(query) ? '' : 'none';
          });
        }

        filterTable('fruits-sections');
        filterTable('swords-sections');
        filterTable('guns-sections');
        filterTable('accessories-sections');
        filterTable('races-sections');
        filterTable('locations-sections');

        const fsRows = document.querySelectorAll('#fighting-styles-table tbody tr');
        fsRows.forEach(row => {
          const text = row.innerText.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        });

        const updateRows = document.querySelectorAll('#updates-table tbody tr');
        updateRows.forEach(row => {
          const text = row.innerText.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        });

        // Toggle clear button
        clearBtn.style.display = searchBar.value ? 'inline-block' : 'none';
      });
    })
    .catch(error => {
      spinner.style.display = "none";
      console.error("❌ Error loading JSON:", error);
      document.querySelector("main").insertAdjacentHTML(
        "afterbegin",
        `<div style="background:#ffdddd;color:#900;padding:1em;margin:1em 0;border:1px solid red;">
          Failed to load <b>data.json</b>: ${error.message}
         </div>`
      );
    });

  // --- UI Interactions outside fetch ---

  // Dark mode toggle
  darkToggle.addEventListener("click", () => {
    body.classList.toggle("dark");
    darkToggle.textContent = body.classList.contains("dark") ? "☀️ Light Mode" : "🌙 Dark Mode";
  });

  // Active nav link on scroll
  window.addEventListener("scroll", () => {
    let current = "";
    document.querySelectorAll("section").forEach(sec => {
      const secTop = sec.offsetTop - 80;
      if (scrollY >= secTop) current = sec.id;
    });
    links.forEach(a => {
      a.classList.remove("active");
      if (a.getAttribute("href") === "#" + current) a.classList.add("active");
    });
  });

  // Filters
  filterBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.filter;
      document.querySelectorAll("section").forEach(sec => {
        sec.style.display = sec.id === target ? "block" : "none";
      });
    });
  });

  // Expand/Collapse All
  document.getElementById("expandAll").addEventListener("click", () => {
    document.querySelectorAll(".collapsible-content").forEach(c => c.classList.add("active"));
  });
  document.getElementById("collapseAll").addEventListener("click", () => {
    document.querySelectorAll(".collapsible-content").forEach(c => c.classList.remove("active"));
  });

  // Scroll to top button
  window.addEventListener('scroll', () => {
    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
      scrollTopBtn.style.display = "block";
    } else {
      scrollTopBtn.style.display = "none";
    }
  });
  scrollTopBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Clear search button
  clearBtn.addEventListener('click', () => {
    searchBar.value = '';
    clearBtn.style.display = 'none';
    searchBar.dispatchEvent(new Event('input'));
  });

});
</script>
</body>
</html>
